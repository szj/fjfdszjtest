    <script type="text/javascript">
        //debugger; 调试时使用
        var gridManager = null;
        var activeDialog = null;
        //菜单id
        var frameId = null;
        var saveFrameId = "qzgfframe" + GetUrlParam('_menuid');
        var dateNows = new Date();
        dateNows = dateNows.getFullYear() + "/" + (dateNows.getMonth() + 1) + "/" + dateNows.getDate();
        var bools = false;

        //页面初始化
        $(function () {
            //该功能选项菜单id
            frameId = GetUrlParam('_menuid');

            f_setToolbar();
            f_setGrid();
        });


        //弹出框
        function f_openWindow(url, title, width, height) {
            var dialogOptions = { width: width, height: height, title: title, url: url, buttons: [
                    {
                        text: '保存', onclick: function (item, dialog) {
                            dialog.frame.f_save(saveFrameId); //f_save调用的是弹出框调用页的方法
                            dialog.close(); //关闭添加窗口
                            f_reload(); //刷新数据
                        }
                    },
                    {
                        text: '关闭', onclick: function (item, dialog) {
                            dialog.close();
                        }
                    }
                ], isResize: true, timeParmName: 'a'
            };
            activeDialog = parent.jQuery.ligerDialog.open(dialogOptions);
        }

        function f_openWindow(url, title, width, height, btnname) {
            if (btnname == null) {
                var dialogOptions = { width: width, height: height, title: title, url: url, buttons: [
                        {
                            text: '保存', onclick: function (item, dialog) {
                                dialog.frame.f_save(saveFrameId); //f_save调用的是弹出框调用页的方法
                                dialog.close(); //关闭添加窗口
                                f_reload(); //刷新数据
                            }
                        },
                        {
                            text: '关闭', onclick: function (item, dialog) {
                                dialog.close();
                            }
                        }
                    ], isResize: true, timeParmName: 'a'
                };
            }
            else {
                var dialogOptions = { width: width, height: height, title: title, url: url, buttons: [
                        {
                            text: btnname, onclick: function (item, dialog) {
                                dialog.frame.f_save(saveFrameId);
                                //f_reload(); //刷新数据
                            }
                        },
                        {
                            text: '关闭', onclick: function (item, dialog) {
                                dialog.close();
                            }
                        }
                    ], isResize: true, timeParmName: 'a'
                };
            }
            activeDialog = parent.jQuery.ligerDialog.open(dialogOptions);
        }

        function f_closeWindow(reload) {
            activeDialog && activeDialog.close();
            reload && f_reload();
        }
        function f_btnClick(item) {
            switch (item.id) {
//                case "add"://添加
//                    f_add();
//                    break;
                case "modify"://修改
                    f_modify();
                    break;
                case "delete"://删除
                    f_delete();
                    break;
                case "loadfile"://导入
                    f_loadfile();
                    break;
                case "search"://查询
                    f_search();
                    break;
                case "button":
                    f_button();
                    break;
                default:
                    $.ligerDialog.alert('暂未实现!');
                    break;
            }
        }

        //查询
        function f_search() {
            f_openWindow('/Cop/Plan/Search/?frameid=' + frameId, '查询模块', 700, 250, '查询');
        }

        function f_button() {
            var rowsdata = gridManager.getCheckedRows();
            if (!rowsdata.length) {
                $.ligerDialog.alert('请先选择行!');
                return;
            }
            var id = rowsdata[0].ID;
            f_openWindow('system/ButtonList.aspx?CurID=' + id, '巡检计划操作管理', 600, 350);
        }

        //添加
        function f_add() {
            f_openWindow('/Cop/Plan/Add/0', '添加巡检计划', 600, 350);
        }

        //修改
        function f_modify() {
            var rowsdata = gridManager.getCheckedRows();
            if (rowsdata.length != 1) {
                $.ligerDialog.alert('请选择一行记录!');
                return;
            }
            var id = rowsdata[0].Id;
            f_openWindow('/Cop/Plan/Edit/' + id, '修改巡检计划', 600, 350);
        }

        //导入
        function f_loadfile() {
            f_openWindow('/Cop/Plan/LoadFile?frameid=' + frameId, '巡检计划信息导入', 800, 350);
        } 

        //批量删除
        function f_delete() {
            var rowsdata = gridManager.getCheckedRows();
            if (!rowsdata.length) {
                $.ligerDialog.alert('请先选择行!');
                return;
            }

            $.ligerDialog.confirm("是否确认删除?", "提示", function (ok) {
                if (ok) {
                    $.ligerDialog.waitting("正在删除中...");
                    var idStr = "";
                    $(rowsdata).each(function (i, item) {
                        idStr += this.Id;
                        if (i < rowsdata.length - 1) idStr += ",";
                    });
                    $.getJSON('/Cop/Plan/Delete?id=' + idStr, { Rnd: Math.random() }, function (data) {
                        if (data.Type) {
                            $.ligerDialog.success("删除成功");
                        }
                        else {
                            $.ligerDialog.error("删除失败!<BR>" + data.Message);
                        }
                        $.ligerDialog.closeWaitting();
                        f_reload();
                    });
                } else {
                    return;
                }
            });

        }

        //设置页面按钮
        function f_setToolbar() {
            SetButtons($("#toolbar"), "/system/menu/GetButton?menuid=20120106091927399766");
        }

        //列表
        function f_setGrid() {
            var leveFlag = $("#leveFlag").val().replace(/[ ]/g, "");
            gridManager = $("#maingrid").ligerGrid({
                columns: [
                { display: '操作', isAllowHide: false,
                    render: function (row) {
                        var html = "";
                        if (leveFlag != "2") {
                            if (row.NextCycTime != null) {
                                //当前时间,如果在"下次巡检时间"之前,就显示"已登记",不能再进行巡检登记
                                duiBiDate(dateNows, row.NextCycTime);
                                var isShow = $("#isShow").val();
                                if (isShow == "1") {
                                     html = '<a href="/Cop/Enrol/Add/' + row.Id + '">巡检登记</a>';
                                } else {
                                     html = '已登记';
                                }
                            } else {
                                html = '<a href="/Cop/Enrol/Add/' + row.Id + '">巡检登记</a>';
                            }
                        }
                        return html;
                    }
                },
                { display: '专线名称', name: 'BizType', align: 'left', width: 130, minWidth: 60 },
                { display: '集团名称', name: 'GroupName', align: 'left', width: 230, minWidth: 60 },
                { display: '所属区县', name: 'District', align: 'left', width: 130, minWidth: 60 },
                { display: '所属公司', name: 'Company', align: 'left', width: 130, minWidth: 60 },
                { display: '业务保障等级', name: 'BizAssuranLeve', align: 'left', width: 90, minWidth: 60 },
                { display: '巡检周期', name: 'CopCycTime', align: 'left', width: 80, minWidth: 60 },
                { display: '巡检起始时间', name: 'StartCycTime', align: 'left', width: 130, minWidth: 60 },
                { display: '下次巡检时间', name: 'NextCycTime', align: 'left', width: 130, minWidth: 60 },
                { display: '巡检延迟天数', name: 'DelayTime', align: 'left', width: 90, minWidth: 60 }
                ], dataAction: 'server',
                url: "/Cop/Plan/GridPager",
                sortName: 'id',
                sortOrder: 'desc',
                width: '99%',
                height: '100%',
                pageSize: 30,
                checkbox: true,
                heightDiff: -9,
                onError: function (a, b) {
                    debugger
                }
            });
        }

        //时间比较
        function duiBiDate(a, b) {
            var arr = a.split("/");
            var starttime = new Date(arr[0], arr[1], arr[2]);
            var starttimes = starttime.getTime();

            var arrs = b.split("/");
            var lktime = new Date(arrs[0], arrs[1], arrs[2]);
            var lktimes = lktime.getTime();
            if (starttimes >= lktimes) {
                $("#isShow").val("1");
            } else {
                $("#isShow").val("0");
            }
        }


        //重新加载列表
        function f_reload() {
            gridManager && gridManager.loadData(true);
        }


    </script>
    <form id="form1" runat="server">
        <div id="toolbar"></div>
        <div id="maingrid"></div>
    </form>
    <input type="hidden" id="leveFlag" value="@ViewData["leveNo"] " />
    <input type="hidden" id="isShow" value="0" />