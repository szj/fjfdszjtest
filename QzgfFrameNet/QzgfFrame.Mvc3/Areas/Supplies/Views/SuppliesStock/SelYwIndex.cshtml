<html xmlns="http://www.w3.org/1999/xhtml">
<head runat="server">
    <title></title> 
    <link href="../../../../Content/Lib/css/EditStyle.css" rel="stylesheet" type="text/css" />
    <link href="../../../../Lib/ligerUI/skins/Silvery/css/ligerui-all.css" rel="stylesheet" type="text/css" />
    <link href="../../../../Lib/ligerUI/skins/ligerui-icons.css" rel="stylesheet" type="text/css" />
    <script src="../../../../Lib/jquery/jquery-1.5.2.min.js" type="text/javascript"></script>
    <script src="../../../../Lib/ligerUI/js/ligerui.all.js" type="text/javascript"></script>  
    <script src="../../../../lib/json2.js" type="text/javascript"></script>
  <script type="text/javascript">
        //debugger; 调试时使用
      var gridManager = null;
      var gridSaleManager = null;
        var activeDialog = null;
        var gridsearch = "";
        var gridSalesearch = "";
        function f_find() {
            if ($("#typename").val() != "") {
                gridsearch = " and (main.SaleDepartmentId='' or main.SaleDepartmentId  is null )";
                gridsearch += " and ast.SuppliesTypeName like '%" + $("#typename").val() + "%'";
            }
            else
                gridsearch = " and (main.SaleDepartmentId='' or main.SaleDepartmentId  is null )";

            if (!gridManager) return;
            gridManager.setOptions(
                { parms: [{ name: 'gridsearch', value: gridsearch}] }
             );
            gridManager.loadData(true);
        }
        function f_findSale() {
            if ($("#SaleDepartmentName").val() != "") {
                gridSalesearch = " and main.SaleDepartmentName like '%" + $("#SaleDepartmentName").val() + "%'";
            }
            else
                gridSalesearch = "";
            if (!gridSaleManager) return;
            gridSaleManager.setOptions(
                { parms: [{ name: 'gridsearch', value: gridSalesearch}] }
             );
            gridSaleManager.loadData(true);
        }
       //选中的耗材信息
        function f_isCheckedTid(rowdata) {
            var strtid = $("#tids").val().split(",");
            for (i = 0; i < strtid.length; i++) {
                if (rowdata.SuppliesTypeId == strtid[i]) {
                    return true;
                }
            }
            return false;
        }
        //选中的营业部信息
        function f_isCheckedSid(rowdata) {
            var strsid = $("#sids").val().split(",");
            for (i = 0; i < strsid.length; i++) {
                if (rowdata.Id == strsid[i]) {
                    return true;
                }
            }
            return false;
        }
        $(function () {
            gridsearch = " and (main.SaleDepartmentId='' or main.SaleDepartmentId  is null )";
            f_setGrid();
            f_setSaleGrid();
        });

        function f_setSaleGrid() {
            var state = "";
            gridSaleManager = $("#mainSaleGrid").ligerGrid({
                columns: [
                { display: '营业部名称', name: 'SaleDepartmentName', align: 'left', width: 130, minWidth: 60 },
                { display: '所属县市', name: 'DistrictName', align: 'left', width: 180, minWidth: 60 },
                { display: '合作单位', name: 'CompanyName', align: 'left', width: 180, minWidth: 60 }
                ], dataAction: 'server',
                url: "/Archives/SaleDepartment/GridSelPager",
                sortName: 'Id',
                sortOrder: 'desc',
                parms: [{ name: "gridsearch", value: gridSalesearch}],
                width: '100%', pageSize: 10, height: '70%',
                checkbox: true, isChecked: f_isCheckedSid,
                heightDiff: -9,
                onError: function (a, b) {
                    debugger
                }
            });
        }
        function f_setGrid() {
            var state = "";
            gridManager = $("#maingrid").ligerGrid({
                columns: [
                { display: '耗材类型名称', name: 'SuppliesTypeName', align: 'left', width: 130, minWidth: 60 },
                { display: '耗材单位', name: 'UnitName', align: 'left', width: 180, minWidth: 60 },
                { display: '数量', name: 'Num', align: 'left', width: 80, minWidth: 60 },
                { display: '所属区县', name: 'DistrictName', align: 'left', width: 180, minWidth: 60 }
                ], dataAction: 'server',
                url: "/Supplies/SuppliesStock/GridSelPager",
                sortName: 'Id',
                sortOrder: 'desc',
                parms: [{ name: "gridsearch", value: gridsearch}],
                width: '100%', pageSize: 10,height:'70%',
                checkbox: true, isChecked: f_isCheckedTid,
                heightDiff: -9,
                onError: function (a, b) {
                    debugger
                }
            });
        }
        function f_reload() {
            gridManager && gridManager.loadData(true);
        }
        function f_getdata() {
            var manager = $("#maingrid").ligerGetGridManager();
            var Salemanager = $("#mainSaleGrid").ligerGetGridManager();
            //manager.getData();
            var rowsdata = gridManager.getCheckedRows();
            var rowsSaledata = Salemanager.getCheckedRows();
            
            if (!rowsdata.length) {
                $.ligerDialog.alert('请先选择耗材类型行!');
                return null;
            }
            if (!rowsSaledata.length) {
                $.ligerDialog.alert('请先选择营业厅信息!');
                return null;
            }
            var ary = new Array();
            var orgary = new Array();
            var allary = new Array();
            $(rowsSaledata).each(function (i, item) {
                var companyId = this.CompanyId;
                var saleDepartmentId = this.Id;
                var saleDepartmentName = this.SaleDepartmentName;
                var addFlag = false; 
                $(rowsdata).each(function (j, item) {
                    var Num = this.Num;
                    if (Num >= 1) {
                        var supplieType = new Object();
                        supplieType["SuppliesTypeId"] = this.SuppliesTypeId;
                        supplieType["SuppliesTypeName"] = this.SuppliesTypeName;
                        supplieType["UnitName"] = this.UnitName;
                        supplieType["CompanyId"] = companyId; 
                        var districtId = this.DistrictId;                
                        supplieType["DistrictId"] = districtId;
                        supplieType["Num"] = 1;
                        supplieType["MaxNum"] = this.Num;
                        supplieType["SaleDepartmentId"] = saleDepartmentId;
                        supplieType["SaleDepartmentName"] = saleDepartmentName;
                        addFlag = true;
                        ary.push(supplieType);
                    }
                });
                if (addFlag == true) {
                    orgary.push(saleDepartmentId);
                }
            });
            allary.push(orgary);
            allary.push(ary);
            return allary;
        }
    </script>
    <style type="text/css">
    #searchbar{margin:0px auto; width:100%; background:#F3F8F9;border-left: 1px solid #B6D3E0;border-bottom: 1px solid #B6D3E0;  border-right: 1px solid #B6D3E0; height:auto; line-height:auto;}
    
.Right_font 
{
    line-height:25px;
    padding-right:10px;
    height:25px;
    border-right:solid #93c7e3 1px;
    background:#eff7fc; 
    border-bottom:solid #93c7e3 1px; 
    text-align:right;
  }
.Left_font 
{
    padding-left: 10px;
    line-height:25px; 
    background:#ffffff;
    padding-right:10px;
    height:25px;
    border-bottom:solid #93c7e3 1px;
    border-right:solid #93c7e3 1px; 
    text-align:left;
}
    </style>
    </head>
    <body>
    <form id="form1" runat="server">
     <div id="searchhbar">
    <table width="100%"><tr><td width="100%" style="font-family:宋体; font-size:12px; ">
   营业部名称：<input type="text" id="SaleDepartmentName" name="SaleDepartmentName"/>
    <input type="button" value="查询" id="Button2" onclick="f_findSale()" class="sel_btn" /> </td></tr></table>
    </div>
    <div id="mainSaleGrid"></div> 
    <div id="searchbar">
    <table width="100%"><tr><td width="100%" style="font-family:宋体; font-size:12px; ">
   耗材类型名称：<input type="text" id="typename" name="typename"/>
    <input type="button" value="查询" id="Button1" onclick="f_find()" class="sel_btn" /> </td></tr></table>
    </div>
    <div id="maingrid"></div> 
    <input type="hidden" id="sids" value="@ViewData["sids"]" />
    <input type="hidden" id="tids" value="@ViewData["tids"]" />
    </form>
    </body>
</html>
