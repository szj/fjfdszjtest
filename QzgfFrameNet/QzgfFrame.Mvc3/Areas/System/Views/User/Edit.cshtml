@model QzgfFrame.System.UserManger.Models.SystemUser
@{
    ViewBag.Title = "Register";
}
@using (Html.BeginForm("edit", "User", FormMethod.Post, new { name = "form1", id = "form1" }))
{
    @Html.HiddenFor(m => m.Id)
    @Html.ValidationSummary(true, "Account creation was unsuccessful. Please correct the errors and try again.")
    <div>
        <table cellpadding="0" border="0" cellspacing="0" class="edittable">
            <tbody>
                <tr>
                    <td align="right" class="editcellmessage">
                        用户名：<span class="l-verify-star">*</span>
                    </td>
                    <td align="left" class="editcell">
                        
                        @if (Model == null || Model.Id == "0")
                        {
                            @Html.TextBoxFor(m => m.Username, new { validate = "{required:true,minlength:1,maxlength:20,remote:'/system/user/isusernameexist?r='+new Date().getTime(),messages:{required:'请输入用户名',remote:'用户名已经存在!'}}", ltype = "text" })

                        }
                        else
                        {
                            @Html.TextBoxFor(m => m.Username, new { ltype = "text", Readonly = "readonly" ,style="background-color:#f5f5f5;color:#dddddd" })
                        }
                        <!--
                    <input id="Username" ltype="text" name="Username" type="text" validate="{required:true,username:true,minlength:1,maxlength:20,remote:'/system/user/Isusernameexist',messages:{required:'请输入用户名',remote:'用户名已经存在!'}}" value="@ViewData["Username"]" />
                   -->
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        姓名：<span class="l-verify-star">&nbsp;</span>
                    </td>
                    <td align="left" class="editcell">
                        @Html.TextBoxFor(m => m.Nickname, new { ltype = "text" })
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        电话：<span class="l-verify-star">&nbsp;</span>
                    </td>
                    <td align="left" class="editcell">
                        @Html.TextBoxFor(m => m.Tel, new { ltype = "text" })
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        电子邮箱：<span class="l-verify-star">&nbsp;</span>
                    </td>
                    <td align="left" class="editcell">
                        @Html.TextBoxFor(m => m.Email, new { ltype = "text" })
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        密码：<span class="l-verify-star">*</span>
                    </td>
                    <td align="left" class="editcell">
                       @*Html.TextBoxFor(m => m.Password, new { validate = "{required:true,minlength:1}", ltype = "text" })*@
                        @Html.PasswordFor(m => m.Password, new { validate = "{required:true,minlength:1}", ltype = "text" })
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        所属公司：<span class="l-verify-star">*</span>
                    </td>
                    <td align="left" class="editcell">
                     @Html.DropDownList("Departmentid", (SelectList)ViewData["company"], new { style = "width:135px", ltype = "select" })

                     @*暂不用机构信息改用下拉的公司信息
                        @Html.TextBoxFor(m => m.Departmentname, new { validate = "{required:true,minlength:1}", ltype = "text" })
                        @Html.HiddenFor(m => m.Departmentid)
                     *@
                    </td>
                </tr>
                 <tr>
                    <td align="right" class="editcellmessage">
                        所属区域：<span class="l-verify-star">*</span>
                    </td>
                    <td align="left" class="editcell">
                        @Html.TextBoxFor(m => m.Areaname, new { validate = "{required:true,minlength:1}", ltype = "text" })
                        @Html.HiddenFor(m => m.Areaid)
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        角色：<span class="l-verify-star">
                            *</span>
                    </td>
                    <td align="left" class="editcell">
                       @Html.TextBoxFor(m => m.Rolenames, new { validate = "{required:true,minlength:1}", ltype = "text" })
                        @Html.HiddenFor(m => m.Roleids)
                    </td>
                </tr>
                <tr>
                    <td align="right" class="editcellmessage">
                        备注：<span class="l-verify-star">&nbsp;</span>
                    </td>
                    <td align="left" class="editcell">
                        @Html.TextAreaFor(m => m.Remark, new { ltype = "text" })
                    </td>
                </tr>
                <tr>
                    <td>
                    </td>
                </tr>
            </tbody>
        </table>
    </div> 
}
<script src="@Url.Content("~/Lib/jquery-validation/jquery.validate.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Lib/jquery-validation/messages_cn.js")" type="text/javascript"></script>
<script src="@Url.Content("~/Lib/jquery-validation/jquery.metadata.js")" type="text/javascript"></script>
<script type="text/javascript">
    //var CurID =  <%=CurID %>;
    var Validator = null;
    $(function () {
        //处理下拉框(部门)
//        $("#Departmentname").ligerComboBox({
//            selectBoxWidth: 200, treeLeafOnly: false,
//            selectBoxHeight: 150, valueFieldID: 'Departmentid', textFieldID: 'Departmentname',
//            //tree: { url: '/system/department/getfather', checkbox: false, topParentIDValue: -1, idFieldName: 'id', parentIDFieldName: 'pid' }
//        });

        //处理下拉框(区域)
        $("#Areaname").ligerComboBox({
            selectBoxWidth: 200, treeLeafOnly: false,
            selectBoxHeight: 150, valueFieldID: 'Areaid', textFieldID: 'Areaname',
            //tree: { url: '/system/department/getfather', checkbox: false, topParentIDValue: -1, idFieldName: 'id', parentIDFieldName: 'pid' }
            tree: { url: '/archives/district/getfather/' + $("#Areaid").val(), checkbox: false, topParentIDValue: -1, idFieldName: 'id', parentIDFieldName: 'pid' }
        });
        
        //方案一:将数据转化为json格式传入ViewData中,然后替换&quot;为双引号,eval转化为json
        //var vdata = (' @*Html.ViewData["DropData"]*@').replace(/&quot;/g, "\"");
        //vdata = eval('(' + vdata + ')');
        $("#Rolenames").ligerComboBox({ isShowCheckBox: true, isMultiSelect: true,
            url: '/system/role/getcombobox',
            valueFieldID: 'Roleids'
        });

        $.metadata.setType("attr", "validate");
        $("#form1").ligerForm();
        deafultValidate($("#form1"));
        Validator = $("#form1").validate();

    });

    //操作成功提示
    function f_success(id) {
        $.ligerDialog.success("保存成功", "提示", function () {
            $.ligerDialog.closeWaitting();
            //刷新当前页面解决用户名验证是否存在问题。
            //window.location.href = window.location.href;
            location.reload(); 
            parent.window.frames[id].f_reload();
        });
    }
    //操作失败提示
    function f_error(message) {
        $.ligerDialog.closeWaitting();
        $.ligerDialog.error(message);
    }
    function f_save(frameid) {
        if (!Validator.form()) return;
        $.ligerDialog.waitting("正在保存中...");
        //提交数据
        var now = $('#form1');
        var path = now[0].action; //参数
        var formdata = now.serialize(); //参数
        f_submit(path, formdata, frameid);
    } 
</script>
