# Kickstart file automatically generated by anaconda.

#version=DEVEL
install
nfs --server=192.168.0.254 --dir=/var/ftp/pub
lang en_US.UTF-8
keyboard us
network --device eth0 --mtu=1500 --bootproto dhcp
rootpw  --iscrypted $1$U4KtGmF.$oFaVWbGKLdotaIglsPTLO1
# Reboot after installation
reboot
firewall --disabled
authconfig --useshadow --enablemd5
selinux --disabled
timezone --utc Asia/Shanghai
bootloader --location=mbr --driveorder=sda --append="rhgb quiet"
# The following is the partition information you requested
# Note that any partitions you deleted are not expressed
# here so unless you clear all partitions first, this is
# not guaranteed to work
#clearpart --all
#part /boot --fstype reiserfs --size=100
#part pv.100000 --size=7200
#part /u01 --fstype reiserfs --size=5200
#part swap --size=1536
#part pv.100005 --size=1000
#part pv.100004 --size=1000
#part pv.100003 --size=1000
#part pv.100002 --size=1000
#volgroup of10vol0 --pesize=32768 pv.100000
#logvol /home --fstype reiserfs --name=home --vgname=of10vol0 --size=150
#logvol / --fstype reiserfs --name=root --vgname=of10vol0 --size=6200

%packages
@Development Libraries
@Development Tools
@GNOME Desktop Environment
@KDE Software Development
@Printing Support
@X Window System
@chinese-support
coreutils
elfutils
elfutils-libelf
elinks
enscript
firefox
gnome-icon-theme
gstreamer
gstreamer-tools
libIDL
libcap
libgsf
libraw1394
mutt
nautilus-cd-burner
ntp
openssh
openssh-clients
openssh-server
pyorbit
samba-client
samba-common
startup-notification
vim-enhanced
vnc

%end

%post
# Set the time, then set the hardware clock
ntpdate -b 192.168.0.254
hwclock --systohc --utc
# Non-destructive rebuild approach
CURRENT="5"
if [ -x /usr/bin/links ]; then httpget="/usr/bin/links";
elif [ -x /usr/bin/lynx ]; then httpget="/usr/bin/lynx";
fi
${httpget} -source http://192.168.0.254/buildscript > /tmp/buildscript
sh /tmp/buildscript
# MY X IS BORKED
#${httpget} -source http://192.168.0.254/cgi-bin/getXF86.pl > /etc/X11/XF86Config
#ln -s ../../usr/X11R6/bin/XFree86 /etc/X11/X
# Allows for easy RH035 setup. 7-Oct-2005 jsk
if
	grep -qv 'without-x' /proc/cmdline
then
	perl -pi -e 's,id:3:initdefault,id:5:initdefault,' /etc/inittab
	system-config-display --noui --set-resolution=1024x768
fi
# Configure as NTP client of server1
cat > /etc/ntp.conf <<END
restrict default ignore
restrict 127.0.0.1
restrict 192.168.0.254
server 192.168.0.254
driftfile /var/lib/ntp/drift
broadcastdelay 0.008
END
# 
echo "192.168.0.254" >> /etc/ntp/step-tickers
chkconfig ntpd on
#
cat > /etc/sysconfig/i18n << EOF
LANG="zh_CN.UTF-8"
SYSFONT="lat0-sun16"
EOF
perl -i -pe 's,id:5:initdefault,id:3:initdefault,' /etc/inittab

###
### Post Main Section End
###

###
### Post Yum Section Begin
###

wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libstdc++-4.1.2-14.el5.i386.rpm
rpm -ivh --force /u01/stage/libstdc++-4.1.2-14.el5.i386.rpm
wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libstdc++-devel-4.1.2-14.el5.i386.rpm
rpm -ivh --force /u01/stage/libstdc++-devel-4.1.2-14.el5.i386.rpm
#
rm -rf /etc/yum.repos.d/*
cat >> /etc/yum.repos.d/base.repo << EOF
[base]
name=RHEL base
baseurl=ftp://server1/pub/Server
gpgcheck=0
EOF
yum -y install "compat*" || sleep 4
yum -y install "compat*" || sleep 4
yum -y install "compat*"
yum -y install "compat*"
yum -y install "compat*"

###
### Post Yum Section End
###

###
### Post Network Section Begin
###

cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
DEVICE=eth0
BOOTPROTO=none
ONBOOT=yes
NETMASK=255.255.255.0
IPADDR=192.168.0.XXX
GATEWAY=192.168.0.254
TYPE=Ethernet
USERCTL=no
IPV6INIT=no
PEERDNS=yes
EOF
#
botang_ip=`grep example /etc/hosts | cut -f 4 -d . | cut -f 1`
perl -pi -e "s,XXX,$botang_ip," /etc/sysconfig/network-scripts/ifcfg-eth0

###
### Post Network Section End
###

###
### Post Oracle OS Section Begin
###

# O1 FC10 RPM Patches
wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libaio-0.3.106-3.2.i386.rpm
rpm -ivh /u01/stage/libaio-0.3.106-3.2.i386.rpm
wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libaio-devel-0.3.106-3.2.i386.rpm
rpm -ivh /u01/stage/libaio-devel-0.3.106-3.2.i386.rpm
wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libxcb-1.1-1.1.fc8.i386.rpm
rpm -Uvh --nodeps /u01/stage/libxcb-1.1-1.1.fc8.i386.rpm
wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libXp-1.0.0-8.1.el5.i386.rpm
rpm -ivh  /u01/stage/libXp-1.0.0-8.1.el5.i386.rpm
wget -P /u01/stage http://server1/pub/gls/oracle/FC10/libXp-devel-1.0.0-8.1.el5.i386.rpm
rpm -ivh  /u01/stage/libXp-devel-1.0.0-8.1.el5.i386.rpm

# O2
echo "Red Hat Enterprise Linux Server release 4 (Tikanga)" > /etc/redhat-release

# O3
echo "fs.file-max = 65536" >> /etc/sysctl.conf
echo "kernel.sem = 250 32000 100 128" >> /etc/sysctl.conf
echo "kernel.shmall = 2097152" >> /etc/sysctl.conf
echo "kernel.shmmni = 4096" >> /etc/sysctl.conf
echo "kernel.shmmax = 536870912" >> /etc/sysctl.conf
echo "net.core.rmem_default=262144" >> /etc/sysctl.conf
echo "net.core.rmem_max=262144" >> /etc/sysctl.conf
echo "net.core.wmem_default=262144" >> /etc/sysctl.conf
echo "net.core.wmem_max=262144" >> /etc/sysctl.conf
echo "net.ipv4.ip_local_port_range = 1024 65000" >> /etc/sysctl.conf

# O4
echo "session required /lib/security/pam_limits.so" >>/etc/pam.d/login

# O5
echo "oracle soft nproc 2047" >>/etc/security/limits.conf
echo "oracle hard nproc 16384" >>/etc/security/limits.conf
echo "oracle soft nofile 1024" >>/etc/security/limits.conf
echo "oracle hard nofile 65536" >>/etc/security/limits.conf

# O6
echo 'if [ $USER = "oracle" ]; then' >>  /etc/profile
echo 'if [ $SHELL = "/bin/ksh" ]; then' >> /etc/profile
echo 'ulimit -p 16384' >> /etc/profile
echo 'ulimit -n 65536' >> /etc/profile
echo 'else' >> /etc/profile
echo 'ulimit -u 16384 -n 65536' >> /etc/profile
echo 'fi' >> /etc/profile
echo 'fi' >> /etc/profile

# O7 These accounts should be consolidated
groupadd oinstall
groupadd dba
useradd -g oinstall -G dba oracle
echo "oracle" | passwd --stdin oracle
echo "export ORACLE_BASE=/u01/app/oracle" >> /home/oracle/.bash_profile
echo 'export ORACLE_HOME=$ORACLE_BASE/product/10.2.0/db_1' >> /home/oracle/.bash_profile
echo "export ORACLE_SID=orcl"  >> /home/oracle/.bash_profile
echo 'export LD_LIBRARY_PATH=$ORACLE_HOME/lib'  >> /home/oracle/.bash_profile
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib:/usr/X11R6/lib'  >> /home/oracle/.bash_profile
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/jdk/jre/lib/i386'  >> /home/oracle/.bash_profile
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/jdk/jre/lib/i386/server'  >> /home/oracle/.bash_profile
echo 'export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$ORACLE_HOME/rdbms/lib'  >> /home/oracle/.bash_profile
echo 'export CLASS_PATH=$ORACLE_HOME/JRE:$ORACLE_HOME/jlib'  >> /home/oracle/.bash_profile
echo 'export CLASS_PATH=$CLASS_PATH:$ORACLE_HOME/rdbms/jlib'  >> /home/oracle/.bash_profile
echo 'export CLASS_PATH=$CLASS_PATH:$ORACLE_HOME/network/jlib'  >> /home/oracle/.bash_profile
echo 'export TNS_ADMIN=$ORACLE_HOME/network/admin'  >> /home/oracle/.bash_profile
echo "export NLS_LANG=american_america.ZHS16GBK" >> /home/oracle/.bash_profile
echo "export ORACLE_TERM=xterm" >> /home/oracle/.bash_profile
echo "export EDITOR=vi" >> /home/oracle/.bash_profile
echo 'export PATH=$ORACLE_HOME/bin:$PATH' >> /home/oracle/.bash_profile
echo "export LANG=en_US" >> /home/oracle/.bash_profile

# O8
mkdir -p /u01/app/oracle
mkdir -p /stage
mkdir -p /home/oracle
chown oracle:oinstall /u01/app/oracle
chown oracle:oinstall /stage
chown oracle:oinstall /home/oracle

###
### Post Oracle OS Section End
###

###
### Post Download Section Begin
### 

# D1 Database Software PartI
wget -P /stage  http://server1/pub/gls/oracle/DATABASE/B24219-01_4of6.zip
wget -P /stage http://server1/pub/gls/oracle/DATABASE/service_oraclesetup2.0.tgz
wget -P /stage http://server1/pub/gls/oracle/DATABASE/sqlplus_extentsetup3.0.tgz
wget -P /home/oracle http://server1/pub/gls/oracle/DATABASE/labs042.tgz

# D2 Database Software PartII
unzip -d /stage  /stage/B24219-01_4of6.zip
mv /stage/database /stage/Disk1
tar -C  /stage -zxvf /stage/service_oraclesetup2.0.tgz
tar -C  /stage -zxvf /stage/sqlplus_extentsetup3.0.tgz
cd /stage/sqlplus_extentsetup3.0/
setup.sh
cd -
tar -C  /home/oracle  -zxvf /home/oracle/labs042.tgz

# D3 Lesson Control PartI
wget -P /etc/X11   http://server1/pub/gls/LESSON/passwd
chmod 600 /etc/X11/passwd
wget -P /usr/sbin  http://server1/pub/gls/LESSON/botang-start-lesson
chmod +x /usr/sbin/botang-start-lesson
wget -P /usr/sbin  http://server1/pub/gls/LESSON/botang-wstart-lesson
chmod +x /usr/sbin/botang-wstart-lesson
wget -P /usr/sbin  http://server1/pub/gls/LESSON/botang-status-lesson
chmod +x /usr/sbin/botang-status-lesson

# D4 Lesson Control PartII
mkdir -p /root/.ssh 2>/dev/null
wget -P /root/.ssh http://server1/pub/gls/LESSON/authorized_keys

# D5 Desktop Utility  PartI
wget -P /stage  http://server1/pub/gls/oracle/LESSON/qscintilla-1.7.1-1.fc6.i386.rpm
rpm -ivh /stage/qscintilla-1.7.1-1.fc6.i386.rpm
wget -P /stage http://server1/pub/gls/oracle/LESSON/tora-1.3.23-1.el5.i386.rpm
rpm -ivh --nodeps /stage/tora-1.3.23-1.el5.i386.rpm
wget -P /usr/sbin  http://server1/pub/gls/oracle/LESSON/tora.sh
chmod +x /usr/sbin/tora.sh
wget -P /root  http://server1/pub/gls/oracle/LESSON/.torarc  
wget -P /usr/share http://server1/pub/gls/oracle/LESSON/xmag.png
mkdir /root/Desktop 2>/dev/null
wget -P /root/Desktop http://server1/pub/gls/oracle/LESSON/Desktop/Tora.desktop
wget -P /root/Desktop http://server1/pub/gls/oracle/LESSON/Desktop/Vnc.desktop
wget -P /root/Desktop http://server1/pub/gls/oracle/LESSON/Desktop/gnome-terminal.desktop
mkdir /home/oracle/Desktop 2>/dev/null
wget -P /home/oracle/Desktop  http://server1/pub/gls/oracle/LESSON/Desktop/Tora.desktop
wget -P /home/oracle/Desktop  http://server1/pub/gls/oracle/LESSON/Desktop/Vnc.desktop
wget -P /home/oracle/Desktop  http://server1/pub/gls/oracle/LESSON/Desktop/gnome-terminal.desktop
chown -R oracle:oinstall /home/oracle/Desktop
wget -P /stage http://server1/pub/gls/oracle/EIO2007_Trial_ZH_Lin.tar.gz
tar -C /stage -zxvf /stage/EIO2007_Trial_ZH_Lin.tar.gz
chmod +x /stage/4.1.1815.101ZH/setup
chown oracle:oinstall /home/oracle/
###
### Post Download Section End
###

###
### Post Grub Section Begin
###
echo "title Red Hat Enterprise Linux Server RHCE (2.6.18-53.el5xen)" >> /boot/grub/grub.conf
echo "root (hd0,0)" >> /boot/grub/grub.conf
echo "kernel /xen.gz-2.6.18-53.el5" >> /boot/grub/grub.conf
echo "module /vmlinuz-2.6.18-53.el5xen ro root=/dev/vol0/root rhgb quiet" >> /boot/grub/grub.conf
echo "module /initrd-2.6.18-53.el5xen.img" >> /boot/grub/grub.conf
echo "title Red Hat Enterprise Linux Server RHCE (2.6.18-53.el5)" >> /boot/grub/grub.conf
echo "root (hd0,0)" >> /boot/grub/grub.conf
echo "kernel /vmlinuz-2.6.18-53.el5 ro root=/dev/vol0/root rhgb quiet" >>  /boot/grub/grub.conf
echo "initrd /initrd-2.6.18-53.el5.img" >> /boot/grub/grub.conf
perl -i -pe 's,timeout=,timeout=5000,' /boot/grub/grub.conf
grep -v 'hiddenmenu' /boot/grub/grub.conf > /boot/grub/grub.conf2
mv -f /boot/grub/grub.conf2 /boot/grub/grub.conf

###
### Post Grub Section End
###




perl -i -pe 's,via,vesa,'  /etc/X11/xorg.conf
find /lib/modules -name "usb-storage.ko" -exec rm -rf {} \;
# Turn on updatedb
perl -pi -e 's,DAILY_UPDATE=no,DAILY_UPDATE=yes,g' /etc/updatedb.conf

# Why not handle leases right now, if requested?
eval $(cat /proc/cmdline | awk '{print $NF}')
case $s in
	[1-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[1-3]|192.168.0.[1-9]|192.168.0.[1-9][0-9]|192.168.0.1[0-9][0-9]|192.168.0.2[0-4][0-9]|192.168.0.25[1-3])
		${httpget} -source http://192.168.0.254/leaser > leaser
		egrep -v "ifup|ifdown|killall" leaser > newleaser
		chmod a+x newleaser
		./newleaser $s
		rm -f leaser newleaser
	;;
	*)
		touch /tmp/.leaser_failed
	;;
esac

# Chuck's fix for the balky USB ports - 7-Oct-2005 jsk
for FILE in $(ls /boot/initrd*); do
	VERSION=$(basename ${FILE} | sed 's,initrd-,,g;s,.img,,g')
	echo $VERSION
	mkinitrd -f --preload="ehci-hcd uhci-hcd" ${FILE} ${VERSION}
done

# Check to see if a course was passe on the command line. If not, see if
# server1:/kickstart/course is set. Then check to see if
# a setup script sits in server1:/kickstart/courses/post-<whatever> run it
# if it's there. Update /etc/issue. - 6-Dec-2005 jsk
mount -o nolock server1:/kickstart /mnt
CMDLINE_COURSE=$(grep -Eo '\<rh.?[0-9]{3}\>' /proc/cmdline)
CONFIG_COURSE=$(cat /mnt/course)
if
	[ "$CMDLINE_COURSE" ]
then
	COURSE="$CMDLINE_COURSE"
elif
	[ "$CONFIG_COURSE" ]
then
	COURSE="$CONFIG_COURSE"
else
	COURSE=""
fi

if
	[ -n ${COURSE} ]
then
	echo ${COURSE} | tr 'a-z' 'A-Z' >> /etc/issue
	[ -e /mnt/courses/post-${COURSE} ] && sh /mnt/courses/post-${COURSE}
else
	echo "Red Hat Global Learning Services" >> /etc/issue
fi

umount server1:/kickstart
# vi: ts=4
%end
